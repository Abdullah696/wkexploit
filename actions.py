##################################
### module containing functions
### author: khemkhem
### date: 19, June 2020
### no modification till now
import requests as r
import os
import sys

#function to get header information from header.txt and data.txt
def headerContent():
    headerData = []
    with open('headers.txt', 'rt') as data:
        for line in data:
            headerData.append(line)
    return headerData

def postData():
    content = ''
    with open('data.txt', 'rt') as text:
        content = text.read()
    return content

#variables for holding information after string manipulation
headerData = headerContent()
data = postData().split('&')


#header information
session = headerData[0][30:56]
identifier = headerData[0][56:len(headerData[0])-9] #value to be passed in each http
userAgent = headerData[2][12:len(headerData[2])-1]

#device information used for logging in
deviceName = data[0].split('=')
mail = data[1].split('=')
buildVersion = data[2].split('=')
phoneid = data[3].split('=') 
pushToken =  data[4].split('=')

#json object data

#function to set the world for host hehe
def setHeaders(world):
    headers = {
        'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8', 
        'User-Agent' : userAgent,
        'Host': world + 'warkingdoms.com', 
        'Connection': 'Keep-Alive',
        'Accept-Encoding' : 'gzip'
        }
    return headers

loginData = {
    'device_name' : deviceName[1],
    'mail': mail[1],
    'buildversion': buildVersion[1],
    'phoneid' : phoneid[1],
    'pushToken' : pushToken[1]
}

def login(world):
    headersInfo = setHeaders(world)
    url = 'http://'+ world + '.warkingdoms.com/android/android_connect/'+ session + identifier
    response = r.post(url, headers = headersInfo, data = loginData).json()
    if(response['success'] == 1):
        print('Successfully logged in!')
        return response
    else:
        print('Failed to log in please try again')
        sys.exit()

def upgrade(world, building, unit):
    url ='http://'+world+'.warkingdoms.com/building/upgrade/'+ building + '/' + unit + identifier
    response = r.get(url).json()
    return response;

def produce(world, building, unit, amount):
    url = 'http://'+world+'.warkingdoms.com/building/produce/'+ building + identifier
    production = {
        'unittype': unit,
        'count': amount
    }
    response = r.post(url, data = production).json()
    return response

#get banner
def display_banner():
    with open ('banner.txt', 'rt') as text:
        banner = text.read()
    os.system('clear')
    print(banner)

def get_servers():
    headersInfo = setHeaders('alex1')
    url = 'http://alex1.warkingdoms.com/home/get_active_servers?confirm_box=1&buildverssion'+buildVersion[1]+'&'+identifier[1:]
    response = r.get(url).json()
    return response
 
def select_world():
    servers = get_servers()
    print("-- Select World:")

    for i in range(3):
        print('['+str(i+1)+']: '+str(servers['servers'][i]['name']))
    world = ''

    while (world != 'q'):
        world = input("Enter your option number: ")
        if (world == 'q'):
            sys.exit()
        elif(world.isdigit()):
            if (int(world) >= 1 and int(world) <= 3):
                break;

    server = str(servers['servers'][int(world)-1]['link'])
    login(server[:-1])
    return server[:-1]

def select_building():
    building = ''
    buildings = ['barracks', 'academy', 'siegeworkshop']
    print("--Select building")
    for i in range(3):
        print('['+str(i+1)+']: '+buildings[i])

    while (building != 'q'):
        building = input("Enter your option number: ")
        if (building == 'q'):
            sys.exit()
        elif(building.isdigit()):
            if (int(building) >= 1 and int(building) <= 3):
                break;

    return buildings[int(building)-1]
     
def select_unit(building):
    unit = ''
    units = {'barracks' : ['rhastati','rvelities', 'rspy', 'rfoederati', 'rprincipes', 'rsagittarii'],'academy' :
    ['geometry', 'metalworking', 'ridingskill', 'espionage', 'cartography', 'masonry'],'siegeworkshop': ['rballista', 'rcatapult']}
    print("--Select troops")
    i = 0

    for troop in units[building]:
        i += 1
        print('['+str(i)+']: ' + str(troop))

    while (unit != 'q'):
        unit = input("Enter your option number: ")
        if (unit == 'q'):
            sys.exit()
        elif(unit.isdigit()):
            if (int(unit) >= 1 and int(unit) <= len(units[building])):
                break;
    return units[building][int(unit)-1]
 
def action(world, building, unit):
   action = ''
   print("-- Select Action")
   if(building == 'academy'):
       print('[1] : Upgrade')
   else:
       print('[1] : Upgrade')
       print('[2] : Produce')
   
   while (action != 'q'):
       action = input("Enter your option number: ")
       if (action == 'q'):
           sys.exit()
       elif(action.isdigit()):
           if (int(action) >= 1 and int(action) <= 2):
               action = int(action)
               break

   if(action  == 1):
       response = upgrade(world, building, unit)
       return response
   elif(action == 2):
       amount = input('Amount: ')
       response = produce(world, building, unit, amount)
       return response


